<!DOCTYPE html>
<html>

<head>
    <title>Music player</title>
    <style type="text/css">

        body {
            font-family: "Arial";
        }

        #search-area {
            text-align: center;
            margin: 20px;
        }

        #search-area input {
            padding: 5px;
            font-size: 1.2em;
        }

        #search-area > p {
            display: none;
        }

        #show-all-icon {
            color: red;
            cursor: pointer;
        }

        table {
            border-collapse: collapse;
            margin: auto;
        }

        tr {
            border: 1px solid gray;
        }

        td {
            padding: 10px;
        }

        tr:hover {
            background: #eef1ef;
        }

        tr.title {
            background: #1c2321;
            color: white;
            font-weight: bold;
        }

        td.buttons {
            text-align: right;
            color: gray;
        }

        td.buttons > span {
            visibility: hidden;
            cursor: pointer;
            padding: 0 5px;
        }

        tr:hover td.buttons > span {
            visibility: visible;
        }

        td.buttons > span:hover {
            color: black;
        }

        .small {
            font-size: 0.75em;
            color: #a9b4c2;
        }

        .small a {
            color: inherit;
        }

        .small a:hover {
            color: #545c52;
        }

    </style>
    <script id="song-list" type="application/json">
        {{ list|safe }}
    </script>
</head>

<body>
    <div id="search-area">
        <input type="text" id="search-query" onkeyup="search(this.value)"
               placeholder="Search all" />
        <p id="currently-showing-p">
            Showing: <span id="currently-showing-span"></span>
            <span id="show-all-icon" onclick="search('')">&#10060;</span>
        </p>
    </div>

    <table id="main-table">
        <tbody id="artist-rows"></tbody>
        <tbody id="album-rows"></tbody>
        <tbody id="song-rows"></tbody>
    </table>

    <script type="text/javascript">

        var search = function(query) {
            // Show all rows whose 'tag' starts with the provided query,
            // and hide all others

            // Hide 'Showing: ...'
            document.getElementById("currently-showing-p").style.display = "none";

            var relevantRows = [];
            for (var i=0; i<allRows.length; i++) {
                // Skip if this row is a title row
                if (allRows[i].className === "title") {
                    continue;
                }

                var tag = allRows[i].getAttribute("data-tag");
                if (tag.toLowerCase().startsWith(query.toLowerCase())) {
                    relevantRows.push(allRows[i]);
                }
            }

            // Show only the relevant rows
            filterTable(relevantRows);
        }

        var filterTable = function(rows) {
            // Hide all rows and only show those in the 'rows' array

            // Hide all the tbodys
            var tbodys = document.getElementById("main-table")
                                 .getElementsByTagName("tbody");
            for (var i=0; i<tbodys.length; i++) {
                tbodys[i].style.display = "none";
            }

            for (var i=0; i<allRows.length; i++) {
                // Hide the row...
                allRows[i].style.display = "none";

                if (rows.indexOf(allRows[i]) >= 0) {
                    // ...and show it if it is contained in rows
                    allRows[i].style.display = "table-row";
                    // Show the parent tbody
                    allRows[i].parentElement.style.display = "table-row-group";
                }
            }
        }

        var sendCommand = function(command) {
            // Convert the command object to a JSON string and send to the server
            httpRequest = new XMLHttpRequest();
            httpRequest.onreadystatechange = handleAjaxReply;
            httpRequest.open("POST", "/send")
            httpRequest.setRequestHeader("Content-type", "application/json")
            httpRequest.send(JSON.stringify(command))
        }

        var handleAjaxReply = function() {
            // Callback function to handle response from an AJAX request
            if (httpRequest.readyState === XMLHttpRequest.DONE) {
                if (httpRequest.status === 200) {
                    reply = JSON.parse(httpRequest.responseText);
                    console.log(reply);
                }
            }
        }

        var createRow = function(contents, attributes) {
            // Return a row DOM object whose inner HTML is 'contents', where
            // 'attributes' is an object where the keys are attributes to be set
            // on the row

            var row = document.createElement("tr");
            var cell = document.createElement("td");
            var buttonsCell = document.createElement("td");
            buttonsCell.className = "buttons";
            row.appendChild(cell);
            row.appendChild(buttonsCell);

            cell.innerHTML = contents;

            // Set attributes
            for (var attr in attributes) {
                row.setAttribute(attr, attributes[attr]);
            }

            // Show child rows (if any exist) when the row is clicked
            row.childRows = [];
            row.onclick = function() {
                if (row.childRows.length > 0) {
                    filterTable(row.childRows);

                    document.getElementById("currently-showing-span")
                            .innerHTML = "'" + contents + "'";

                    document.getElementById("currently-showing-p")
                            .style.display = "block";
                }
            };

            return row;
        }

        var addButtonToRow = function(button, row) {
            // Add the provided button to the row
            row.getElementsByClassName("buttons")[0].appendChild(button);
        }

        var createLink = function(text, callback) {
            // Return a DOM object for a link that calls the provided callback
            // function when clicked

            var link = document.createElement("a");
            link.setAttribute("href", "#");
            link.innerHTML = text;
            link.onclick = function(event) {
                callback();
                event.stopPropagation();
            };
            return link;
        }

        var addRowLinks = function(links, row) {
            var cell = row.getElementsByTagName("td")[0];
            cell.innerHTML += "<br />";

            var smallText = document.createElement("span");
            smallText.className = "small";

            for (var i=0; i<links.length; i++) {
                smallText.appendChild(links[i]);

                // If this is not the last link...
                if (i + 1 < links.length) {
                    // ...put a separator in
                    smallText.appendChild(
                        document.createTextNode(" | ")
                    );
                }
            }

            cell.appendChild(smallText);
        }

        var createPlayButton = function(songs) {
            // Create an icon for playing the songs provided. songs should be a
            // list of objects with values for artist, album and song
            var icon = document.createElement("span");
            icon.innerHTML = "&#9654;";
            icon.onclick = function(event) {
                console.log("Playing the following songs:")
                for (var i=0; i<songs.length; i++) {
                    console.log("  * " + songs[i].song + " by " + songs[i].artist);
                }

                // Stop the event bubbling up - otherwise the row containing
                // this button will be clicked
                event.stopPropagation();
            };
            return icon;
        }

        var library = {};
        var allRows = [];

        var songList = JSON.parse(document.getElementById("song-list").innerHTML);

        if (songList["status"] === "okay") {
            var httpRequest;  // Used for AJAX calls

            library = songList["message"];

            var artistRows = [];
            var songRows = [];
            var albumRows = [];

            // Build up lists of artists, albums and songs
            for (let artist in library) {

                // Create a row for this artist
                let artistRow = createRow(artist, {"data-tag": artist});
                artistRow.childRows.push(artistRow);
                artistRows.push(artistRow);

                for (let album in library[artist]) {

                    // Create a list of songs for this album to create the play
                    // button
                    let albumSongs = [];

                    // Create a row for this album
                    let albumRow = createRow(album, {"data-tag": album});
                    albumRow.childRows.push(albumRow);
                    albumRows.push(albumRow);

                    // Add a link to artist
                    let artistLink = createLink(artist, artistRow.onclick);
                    addRowLinks([artistLink], albumRow);

                    // Add this album as a 'child row' of the artist row and
                    // vice versa
                    artistRow.childRows.push(albumRow);
                    albumRow.childRows.push(artistRow);

                    for (var i=0; i<library[artist][album].length; i++) {
                        var song = library[artist][album][i];

                        // Create song object used for actually sending JSON
                        // to the server
                        var songObject = {"artist": artist, "album": album,
                                          "song": song};
                        albumSongs.push(songObject);

                        // Create a row for this song
                        var playButton = createPlayButton([songObject]);
                        var niceName = song.slice(3, -4)
                        let songRow = createRow(niceName,
                                                {"data-tag": niceName});
                        addButtonToRow(playButton, songRow);
                        songRows.push(songRow);

                        // Add a link to artist and album
                        let links = [
                            createLink(album, albumRow.onclick),
                            createLink(artist, artistRow.onclick)
                        ];
                        addRowLinks(links, songRow);

                        // Add this song as a 'child row' for the album and
                        // artist
                        albumRow.childRows.push(songRow);
                        artistRow.childRows.push(songRow);
                    }

                    // Add a play button to the album row
                    var albumPlayButton = createPlayButton(albumSongs);
                    addButtonToRow(albumPlayButton, albumRow);
                }
            }

            // TODO: Sort rows

            // Add title rows
            document.getElementById("artist-rows").appendChild(
                createRow("Artists", {"class": "title"})
            );
            document.getElementById("album-rows").appendChild(
                createRow("Albums", {"class": "title"})
            );
            document.getElementById("song-rows").appendChild(
                createRow("Songs", {"class": "title"})
            );

            // Add rows to page
            var d = [
                [artistRows, "artist-rows"],
                [albumRows, "album-rows"],
                [songRows, "song-rows"]
            ];
            for (var i=0; i<d.length; i++) {
                var parent = document.getElementById(d[i][1]);
                for (var j=0; j<d[i][0].length; j++) {
                    parent.appendChild(d[i][0][j]);
                }
            }

            allRows = artistRows.concat(albumRows).concat(songRows);
        }
        else {
            // TODO: Do proper error handling
            alert("Error getting song list");
        }

    </script>

</body>

</html>