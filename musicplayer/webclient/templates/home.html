<!DOCTYPE html>
<html>

<head>
    <title>Music player</title>
    <style type="text/css">

        body {
            font-family: "Arial";
        }

        #search-area {
            text-align: center;
            margin: 20px;
        }

        #search-area input {
            padding: 5px;
            font-size: 1.2em;
        }

        table {
            border-collapse: collapse;
            margin: auto;
        }

        tr {
            border: 1px solid gray;
            cursor: pointer;
        }
        td {
            padding: 10px;
        }

        tr:hover {
            background: #efefef;
        }

        tr.title {
            background: black;
            color: white;
            font-weight: bold;
        }

        td.buttons {
            text-align: right;
            color: gray;
        }

        td.buttons > span {
            visibility: hidden;
            cursor: pointer;
            padding: 0 5px;
        }

        tr:hover td.buttons > span {
            visibility: visible;
        }

        td.buttons > span:hover {
            color: black;
        }

    </style>
    <script id="song-list" type="application/json">
        {{ list|safe }}
    </script>
</head>

<body>
    <div id="search-area">
        <input type="text" id="search-query" onkeyup="search(this.value)"
               placeholder="Search all" />
    </div>

    <table id="main-table">
        <tbody id="artist-rows"></tbody>
        <tbody id="album-rows"></tbody>
        <tbody id="song-rows"></tbody>
    </table>

    <script type="text/javascript">

        var search = function(query) {
            var relevantRows = [];
            for (var i=0; i<allRows.length; i++) {
                // Skip if this row is a title row
                if (allRows[i].className === "title") {
                    continue;
                }

                var tag = allRows[i].getAttribute("data-tag");
                if (tag.toLowerCase().startsWith(query.toLowerCase())) {
                    relevantRows.push(allRows[i]);
                }
            }

            // Show only the relevant rows
            filterTable(relevantRows);
        }

        var filterTable = function(rows) {
            // Hide all rows and only show those in the 'rows' array
            for (var i=0; i<allRows.length; i++) {
                allRows[i].style.display = "none";

                if (rows.indexOf(allRows[i]) >= 0) {
                    allRows[i].style.display = "table-row";
                }
            }
        }

        var sendCommand = function(command) {
            // Convert the command object to a JSON string and send to the server
            httpRequest = new XMLHttpRequest();
            httpRequest.onreadystatechange = handleAjaxReply;
            httpRequest.open("POST", "/send")
            httpRequest.setRequestHeader("Content-type", "application/json")
            httpRequest.send(JSON.stringify(command))
        }

        var handleAjaxReply = function() {
            // Callback function to handle response from an AJAX request
            if (httpRequest.readyState === XMLHttpRequest.DONE) {
                if (httpRequest.status === 200) {
                    reply = JSON.parse(httpRequest.responseText);
                    console.log(reply);
                }
            }
        }

        var createRow = function(contents, buttons, attributes) {
            // Return a row DOM object whose inner HTML is 'contents', where
            // buttons are the DOM objects to be shown as button, and
            // 'attributes' is an object where the keys are attributes to be set
            // on the row
            var row = document.createElement("tr");
            var cell = document.createElement("td");
            var buttonsCell = document.createElement("td");
            buttonsCell.className = "buttons";
            row.appendChild(cell);
            row.appendChild(buttonsCell);

            cell.innerHTML = contents;
            // Put buttons in
            for (var i=0; i<buttons.length; i++) {
                buttonsCell.appendChild(buttons[i]);
            }

            // Set attributes
            for (var attr in attributes) {
                row.setAttribute(attr, attributes[attr]);
            }

            return row;
        }

        var createPlayButton = function(songs) {
            // Create an icon for playing the songs provided. songs should be a
            // list of objects with values for artist, album and song
            var icon = document.createElement("span");
            icon.innerHTML = "&#9654;";
            icon.onclick = function() {
                console.log("Playing the following songs:")
                for (var i=0; i<songs.length; i++) {
                    console.log("  * " + songs[i].song + " by " + songs[i].artist);
                }
            };
            return icon;

            //&#8801;
        }

        var library = {};
        var allRows = [];

        var songList = JSON.parse(document.getElementById("song-list").innerHTML);

        if (songList["status"] === "okay") {
            var httpRequest;  // Used for AJAX calls

            library = songList["message"];

            var artistRows = [];
            var songRows = [];
            var albumRows = [];

            // Build up lists of artists, albums and songs
            for (var artist in library) {

                // Keep track of all the rows for albums and songs for this
                // artist
                let artistChildRows = []

                for (var album in library[artist]) {

                    // Create a list of songs for this album to create the play
                    // button
                    let albumSongs = [];
                    // Keep track of songs rows for this album
                    let albumChildRows = [];

                    for (var i=0; i<library[artist][album].length; i++) {
                        var song = library[artist][album][i];

                        // Create song object used for actually sending JSON
                        // to the server
                        var songObject = {"artist": artist, "album": album,
                                          "song": song};
                        albumSongs.push(songObject);

                        // Create a row for this song
                        var playButton = createPlayButton([songObject]);
                        var row = createRow(song, [playButton],
                                            {"data-tag": song});
                        songRows.push(row);

                        albumChildRows.push(row);
                    }

                    // Create a row for this album
                    var playButton = createPlayButton(albumSongs);
                    var row = createRow(album, [playButton],
                                        {"data-tag": album});
                    row.onclick = function() {
                        filterTable(albumChildRows);
                    };
                    albumRows.push(row);

                    // Add album row to artistChildRows...
                    artistChildRows.push(row);
                    // ...and add all song rows for this album too
                    artistChildRows = artistChildRows.concat(albumChildRows);
                }

                // Create a row for this artist
                var row = createRow(artist, [], {"data-tag": artist});
                row.onclick = function() {
                    filterTable(artistChildRows);
                };
                artistRows.push(row);
            }

            // TODO: Sort rows

            // Add title rows
            document.getElementById("artist-rows").appendChild(
                createRow("Artists", [], {"class": "title"})
            );
            document.getElementById("album-rows").appendChild(
                createRow("Albums", [], {"class": "title"})
            );
            document.getElementById("song-rows").appendChild(
                createRow("Songs", [], {"class": "title"})
            );

            // Add rows to page
            var d = [
                [artistRows, "artist-rows"],
                [albumRows, "album-rows"],
                [songRows, "song-rows"]
            ];
            for (var i=0; i<d.length; i++) {
                var parent = document.getElementById(d[i][1]);
                for (var j=0; j<d[i][0].length; j++) {
                    parent.appendChild(d[i][0][j]);
                }
            }

            allRows = artistRows.concat(albumRows).concat(songRows);
        }
        else {
            // TODO: Do proper error handling
            alert("Error getting song list");
        }

    </script>

</body>

</html>